Config File
-----------

This section explains how a gaulois-pipe config file must be, and how it is interpreted.

### Namespace

The whole config file is in

http://efl.fr/chaine/saxon-pipe/config

There is no element or attributes outside of this namespace.

### Sample file
```
<config xmlns="http://efl.fr/chaine/saxon-pipe/config"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://efl.fr/chaine/saxon-pipe/config
                        ../../../src/main/resources/fr/efl/chaine/xslt/schemas/saxon-pipe\_config.xsd">
    <pipe mutiThreadMaxSourceSize="24349456" nbThreads="4" traceOutput="logs/trace.log">
        <xslt href="./src/test/resources/step1.xsl">
            <param name="p-step1" value="step1"/>
        </xslt>
        <tee>
            <pipe>
                <xslt href="./src/test/resources/step2.xsl" traceActive="true">
                    <param name="p-step2" value="step2"/>
                </xslt>
                <output id="step1">
                    <folder relative="./target/generated-test-files" to="${user.dir}"/>
                    <fileName name="step1-output.xml"/>
                </output>
            </pipe>
            <pipe>
                <tee>
                    <pipe>
                        <xslt href="./src/test/resources/step3.xsl">
                            <param name="p-step3" value="step3"/>
                        </xslt>
                        <output id="step3">
                            <folder relative="./target/generated-test-files" to="${user.dir}"/>
                            <fileName name="step3-output.xml"/>
                        </output>
                    </pipe>
                    <pipe>
                        <output id="step2">
                            <folder relative="./target/generated-test-files" to="${user.dir}"/>
                            <fileName name="step2-output.xml"/>
                        </output>
                    </pipe>
                </tee>
            </pipe>
        </tee>
    </pipe>
    <params>
        <param name="p-general" value="GENERAL"/>
    </params>
    <sources>
        <folder href="./src/test/resources" pattern="source.\*xml"/>
    </sources>
</config>
```

Under `<config>` element, we may have :

*   An optional [namespaces](#namespaces)
*   An optional [grammars](#grammars)
*   A [pipe](#pipe)
*   A [params](#params)
*   A [sources](#sources)

### pipe

#### Attributes

| Attribute | Required ? | Value | Value if omitted |
|-----------|------------|-------|------------------|
| nbThreads | No         | positive integer | 1     |
| mutiThreadMaxSourceSize | No | file size in bytes | 10485760 (10Mb) |
| traceOutput | No | The location where to store traces. valid values are `#logger`, `#standard` or any writable URL. `#logger` uses default logger of gaulois-pipe, i.e. the log4j logger. `#standard` uses default Saxon logger, as defined in Saxon configuration | None |

#### Elements

The pipe **must** start with a [xslt](#xslt). Then, it may have [xslt](#xslt), [java](#java). A pipe is terminated with either a [tee](#tee) or a[output](#output).

**Nothing can** follow an [output](#output) ; output is always a terminal node.

##### xslt

A `<xslt>` is a step where transformation is made by a XSL transformation. @href specifies the XSL location ; it may be an absolute URL or a relative URL. Relative URL are relative to `System.getProperty("user.dir")`. This will change in a future minor release.

There is no restriction on XSL you use, except the Saxon Release you use must be compliant with your XSL. You may want to change the Saxon Release you use with Gaulois-pipe : create your own maven project, add a dependency to gaulois-pipe, and add exception on net.sf.saxon:Saxon-HE ; do not forget to add your own Saxon dependency, and the license, if required.

You can add a `traceActive="true"` attribute, to allow traces generated by [fn:trace()](https://www.w3.org/TR/xpath-functions-30/#func-trace) XPath function to be stored. If used, `ancestor::pipe/@traceOutput` must be present.

You can set the `debug="true"` attribute - you must define the `@id` attribute in this case - the result of the Xslt will be written in the current directoy or in the directory defined in system property `gaulois.debug.dir`, in a name called `id-$[input-name]`.

A `<xsl>` may have parameters defined as [param](#param) sub-elements.

##### java

A `<java>` step is a class that may filter or transform the events send by Saxon processor. A Java Step must extends [fr.efl.chaine.xslt.StepJava](apidocs/fr/efl/chaine/xslt/StepJava.html).

When used into a `<pipe>`, a java step must not be a terminal step or a initial step, and so its [getNextReceiver](apidocs/fr/efl/chaine/xslt/StepJava.html#getNextReceiver(net.sf.saxon.Configuration)) method must not return null.  
[FileAppenderStep](apidocs/fr/efl/chaine/xslt/utils/FileAppenderStep.html) is such a step sample you can use.

When used in a [&lt;source&gt;](#source), the step is either an initial step and a terminal step, and so underlying [Receiver](http://www.saxonica.com/html/documentation/javadoc/net/sf/saxon/event/Receiver.html) must not be a [ProxyReceiver](http://www.saxonica.com/html/documentation/javadoc/net/sf/saxon/event/ProxyReceiver.html). [FileAppenderTerminalStep](apidocs/fr/efl/chaine/xslt/utils/FileAppenderTerminalStep.html) is such a step sample you can use.

A `<java>` may have parameters defined as [param](#param) sub-elements.

##### choose

A choose allows you to control the structure of the pipe, depending on XPath expression evaluations. It's very similar to XSL syntax, except that otherwise is required. A choose must always "return" a sub-pipe.

```
            <xslt href="cp:/pre-process.xsl"/>
            <choose>
                <when test="/mydoc/meta/@pubYear/xs:integer(.) lt 2000">
                    <xslt href="cp:/very-old-fashion.xsl"/>
                </when>
                <when test="/mydoc/meta/@pubYear/xs:integer(.) lt 2000">
                    <xslt href="cp:/old-fashion.xsl"/>
                </when>
                <otherwise>
                    <xsl href="cp:/current.xsl"/>
                </otherwise>
            </choose>
            <output id="main">...</output>
```

The XPath expressions are evaluated on the input document, and are not evaluated on the result document of the previous step.

##### tee

A `<tee>` allows to fork the pipe to two or plus other destinations, each destination terminated by an [output](output). You must provide a pipe\[2,...\] sub-pipes.

**Warning:** there is no backward compatibility from previous releases, where you used pipe1 and pipe2 childs.

##### output

An `<output>` is used to define where the pipe result have to be written. An `<output>` is defined by a [folder](#outputFolder) and a [fileName](#fileName), or is a null output, and contains only a [null](#nullOutput). It may define as attributes all the saxon-supported output properties. See [SaxonOutputKeys](http://www.saxonica.com/html/documentation/javadoc/net/sf/saxon/lib/SaxonOutputKeys.html).

###### null

`<null />` defines that output is lost and must not be written. When using null, all other elements or forbidden.

###### folder

`<folder>` defines the folder where to write output files. It can be a relative reference, or an absolute URI. If relative attribute is defined (it must be a relative URI), then the to attribute must be also defined. You can use parameters values, with the $\[param\] syntax, and also use System properties, with the `${system.property}` syntax.

###### fileName

`<fileName>` allows to define a rule to calculate the target file name. The rule is to concatenate a prefix, a name, and a suffix. The name attribute is required, prefix and suffix are optionals. You can use parameters values, system properties, with the appropriate escape syntax, and three special properties are available, with the system property escape syntax :

*   name: the original source file name
*   basename: the original source file name, without extension
*   extension: the original source file extension

### params

`<params>` are used to define parameters that are given at all XSL and Java steps. Defined here, they are global parameters. They may be overwritten by command-line parameters.

Once a param is defined, you can use it everywhere, with this escape syntax : $\[paramName\]

Few predefined parameters may be used everywhere in the pipe :

*   $\[input-name\] : the input file name currently processed
*   $\[input-basename\] : the input file basename (without extension) currently processed
*   $\[input-extension\] : the input file name extension currently processed
*   $\[input-absolute\] : the absolute file path currently processed
*   $\[input-relative-file\] : if file was loaded from //sources/folder it contains the relative file path to folder/@href in an URI form (/delimited), else it is the absolute URI of input file
*   $\[input-relative-dir\] : if file was loaded from //sources/folder it contains the relative dir path to folder/@href in an URI form (/delimited), else it is the absolute URI of input file parent directory

### sources

`<sources>` allows to define which files are to be processed by the pipeline.

Files may be specified one by one, via the [file](#file) element, by folder, via the [element](#folder), or a HTTP listener can be started to listen to files to process, when you don't know which files to process when you start gaulois-pipe.

##### file

`<file>` specifies only one file, via an absolute URI on the href attribute. You may use elsewhere-defined parameters in the URI. You may add parameters inside ; those parameters will be passed to XSL and Java steps when processing this file.

##### folder

`<folder>` allows to select many files in a folder. Specify the folder absolute URI in the href attribute, specify to recuse or not in the recurse attribute, and specify the pattern to match files in the pattern attribute. You can only specify one pattern per folder, but you may specify the same folder URI many times. You may use elsewhere-defined parameters in the URI. You may add parameters inside ; those parameters will be passed to XSL and Java steps when processing this file.

##### listener

A listener allows to start gaulois-pipe as a waiting http server. You specify the port (default is 8888), the keyword that must be used to stop the server.

When definig a listener in gaulois-pipe, gaulois-pipe does not stop when all files defined with [file](#file) or [folder](#folder) ; gaulois-pipe keep working until he receives a DELETE http request, with a keyword parameter ; keyword parameter value must be the one defined in the keyword attribute.

```
http://localhost:8888/?keyword=STOP \[DELETE http method\]
```

To add files, send a http PUT request, defining a url parameter that contains the absolute url of the file to process. It **must** be an URL on the **file:** protocol. If you have parameters to pass to steps, define all the additional parameters you need.

```
http://localhost:8888/?url=file%3A%2Fhome%2Fcmarchand%2Fdata%2Fcollection.xml&ciType=actu \[PUT http method\]
```

When the DELETE request is received, and if it is valid, the server does not accepts anymore files, the http server stops, and gaulois-pipe stops when all input files have been processed.

#### Namespaces

namespaces are used to define namespace/prefix bindings, to be used in XPath expression in [choose](#choose).

```
    <namespaces>
        <mapping prefix="n" uri="http://www.minefi.gouv.fr/cp/helios/pes\_v2/paye\_1\_1"/>
    </namespaces>
    <pipe>
      <xslt href="cp:/identity.xsl"/>
      <choose>
        <when test="/n:DocumentPaye/n:Annee/@V/xs:integer(.) gt 2012">
      ...          
```

Here, when evaluating `/n:DocumentPaye/n:Annee/@V`, n prefix is bound to `http://www.minefi.gouv.fr/cp/helios/pes_v2/paye_1_1`

You may define as many mappings as you need.

#### Grammars

grammars allow to define schemas used by Saxon in xsl. If a XL uses `<xsl:import-schema href="..."/>`, when Saxon compiles the XSL, the schema is stored in Saxon [Configuration](http://saxonica.com/html/documentation/javadoc/net/sf/saxon/Configuration.html), and the schema is available when executing XSL.

If you use compiled XSL (i.e. .sef files), compiled XSL does not contains imported schema, and then, when running XSL, error SXPK0003 is raised. To avoid this, you may declare in grammars the schema(s) your XSL will use. Then, gaulois-pipe is able to load declared schemas in Saxon configuration, and make them available when running XSL.

```
    <config xmlns="http://efl.fr/chaine/saxon-pipe/config">
      <grammars>
        <schema href="cp:/EE/schema.xsd"/>
      </grammars>
      <pipe>
        <xslt href="cp:/EE/schema-aware.xsl"/>
        ...
```     

As usual, relative URI may be used, and they are relative to current directory.
